Подписание документов электронной подписью
===========================================

.. _esign_settings:

Функционал подписания ЭЦП может быть добавлен к любому типу данных. Для этого были добавлены - специальная настройка виджета **"Свойства"** и действия.

Виджет "Свойства - Электронная подпись"
-----------------------------------------

Для виджета :ref:`Свойства<widget_properties>` добавлена настройка **Электронная подпись**. Для ее ее использования на карточке:

1. :ref:`Добавьте на дашборд<page_settings>` карточки виджет **"Свойства"**. 
 
2. В настройках виджета:

.. image:: _static/esign/00.png
       :width: 600
       :align: center 

выберите **Электронная подпись**: 

.. list-table::
      :widths: 20 20
      :align: center

      * - |

            .. image:: _static/esign/01.png
                  :width: 400
                  :align: center

        - |

            .. image:: _static/esign/02.png
                  :width: 450
                  :align: center


3. У подписанных ЭЦП документов в карточке буду отображаться данные о сертификате ЭЦП и времени подписания:

.. image:: _static/esign/03.png
       :width: 300
       :align: center 

Действия
-----------

Доступные действия для подписания контента и скачивания подписи: 

1. Действие **Подписать документ** (Базовый контент) - sign-document-content-default
   
  - Доступно, если у документа есть свойство **content** и отсутствует прикрепленная подпись.
  - Формирует подпись на основе выбранного сертификата и контента в атрибуте **content** и прикрепляет к подписываемому документу.

2. Действие **Подписать документ** - sign-document-content
   
   - На текущий момент нет условия для ограничения видимости действия.
   - Действие отображает форму, на которой требуется выбрать атрибут с контентом, который необходимо подписать, затем выбор сертификата, подписывается только выбранный контент, если у типа только один атрибут типа **content**, то выбор атрибута с контентом происходит автоматически.

3. Действие **Скачать подпись** - download-sign-content
   
   - Скрыто по умолчанию, появляется у документа если его контент подписан через Citeck нашей электронной подписью Esign.sign)

Возможность при подписании опционально проверять загруженную в Citeck доверенность
------------------------------------------------------------------------------------

Добавлен конфиг **edi-sign-with-attorney**. Возможные значения (true/false)

.. image:: _static/esign/13.png
       :width: 800
       :align: center 

При включении добавляет на действие подписания проверку МЧД.

Проверка МЧД при нажатии на кнопку подписания:

1. МЧД отсутствует или невалидны даты - открывается обычная форма подписи, подписание не блокируется, в виджете нет отметки о МЧД.
2. МЧД найдена, даты валидны - открывается обычная форма подписи, документ подписывается, в виджете появляется отметка о МЧД, без дополнительной информации о доверенности:

.. image:: _static/esign/14.png
       :width: 600
       :align: center

Пример использования действия "Подписать документ"
------------------------------------------------------

1. Создайте :ref:`тип данных<data_types_main>`, добавьте к нему действия - **Подписать документ** и **Скачать подпись**:

.. image:: _static/esign/04.png
       :width: 600
       :align: center 

2. На вкладке **"Атрибуты"** укажите два атрибута с типом **content** и сохраните.

.. image:: _static/esign/05.png
       :width: 600
       :align: center

3. :ref:`Добавьте журнал<journal_to_menu>` в меню рабочего пространства. 

4. Создайте карточку:

.. image:: _static/esign/06.png
       :width: 500
       :align: center

5. Далее настройте дашборд карточки:

.. image:: _static/esign/08.png
       :width: 600
       :align: center

Добавьте виджет **"Свойства" (2)** и примените для созданного типа **(1)**:

.. image:: _static/esign/09.png
       :width: 550
       :align: center

Перейдите в настройки виджета:

.. image:: _static/esign/09_1.png
       :width: 600
       :align: center

и выберите **Электронная подпись**:

.. image:: _static/esign/02.png
      :width: 500
      :align: center

Добавленный в карточку виджет:

.. image:: _static/esign/10.png
       :width: 600
       :align: center

6. Создайте документ. Выберите действие **Подписать документ**, выберите файл:

.. image:: _static/esign/11.png
       :width: 500
       :align: center

7. В карточке буду отображаться данные о сертификате ЭЦП и времени подписания:
   
.. image:: _static/esign/12.png
       :width: 600
       :align: center

Файл подписи можно скачать, используя действие **Скачать подпись**.