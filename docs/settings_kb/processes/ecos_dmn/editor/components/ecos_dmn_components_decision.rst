Решение
========

.. _dmn_decision:

**Решение** - узел, в котором один или несколько входных элементов определяют выход на основе бизнес-логики принятия решения, определенной в виде выражения или таблицы.

При создании новой модели по умолчанию добавлен элемент **решение**:

 .. image:: _static/decision/decision_1.png
       :width: 600
       :align: center

Кликнув на решение, в правой части становятся доступны свойства элемента:

 .. image:: _static/decision/decision_2.png
       :width: 600
       :align: center

Кликнув дважды на элемент, его можно переименовать или наименование можно поменять в свойствах.

Для ввода данных в таблицу кликните:

 .. image:: _static/decision/decision_3.png
       :width: 200
       :align: center

Откроется таблица для заполнения:

 .. image:: _static/decision/decision_4.png
       :width: 600
       :align: center

По клику правой кнопки мыши на ячейку шапки таблицы становится доступно меню:

 .. image:: _static/decision/decision_17.png
       :width: 180
       :align: center

Используя меню, можно добавить, скопировать/вставить, или удалить ячейки.

По клику на **View DRD** осуществляется переход назад к модели принятия решения.

Далее рассмотрим элементы таблицы принятия решения.

Описание элементов таблицы принятия решений
----------------------------------------------

Таблица решений представляет собой логику принятия решений, которая может быть представлена в виде таблицы. 
Логика состоит из входов, выходов и правил.

 .. image:: _static/decision/decision_5.png
       :width: 700
       :align: center

1.	Наименование таблицы решений
2.	Политика выбора
3.	Входной элемент
4.	Выходной элемент
5.	Правило

По клику правой кнопки мыши на строку решения становится доступно меню:

 .. image:: _static/decision/decision_16.png
       :width: 200
       :align: center

Используя меню, можно добавить, скопировать/вставить, или удалить строки решений, изменить язык выражения.

Политика выбора
~~~~~~~~~~~~~~~~

.. _dmn_hit_policy:

 .. image:: _static/decision/decision_6.png
       :width: 200
       :align: center

Таблица решений имеет политику выбора, которая указывает, из чего состоят результаты оценки таблицы решений.

Политика выбора определяет, сколько правил таблицы решений может быть удовлетворено и какие из удовлетворяемых правил включаются в результат таблицы решений. 

Политики выбора **Unique, Any и First** всегда будут возвращать не более одного удовлетворяемого правила. 

Политики выбора **Rule Order и Collect** могут возвращать несколько удовлетворенных правил.

.. list-table::
      :widths: 10 30
      :align: center
      :header-rows: 1
      :class: tight-table 
      
      * - Политика
        - Описание
      * - **Unique (Уникальная)**
        - | Может быть выполнено только одно правило или вообще не может быть выполнено правило. Результат таблицы решений содержит выходные записи удовлетворенного правила.
          | Если выполняется более одного правила, нарушается политика уникального выбора.
          | Является политикой выбора по умолчанию.
      * - **First (Политика первого совпадения)**
        - | Можно удовлетворить несколько правил. Результат таблицы решений содержит только вывод первого выполненного правила.
      * - **Priority**
        - | Выходные данные правил имеют приоритет. 
          | Правила могут перекрываться, но учитывается только совпадение с наивысшим выходным приоритетом.Пока не реализовано.
          | Пока не реализовано.
      * - **Any (Любая)**
        - | Можно удовлетворить несколько правил. Однако все удовлетворяемые правила должны генерировать один и тот же результат. 
          | Результат таблицы решений содержит только вывод одного из удовлетворенных правил.
          | Если выполняются несколько правил, которые генерируют разные выходные данные, политика выбора нарушается.
      * - **Collect (Сбор)**
        - | Можно удовлетворить несколько правил. Результат таблицы решений содержит вывод всех удовлетворяемых правил в произвольном порядке в виде списка.
          | Кроме того, для политики выбора Collect можно указать агрегатор.
          | Если указан агрегатор, результат таблицы решений будет содержать только одну выходную запись. Агрегатор сгенерирует выходную запись из всех удовлетворенных правил. 
          | Для политики выбора Collect доступны :ref:`следующие операторы<dmn_collect_operators>`
      * - **Rule order (Порядок применения правил)**
        - | Можно удовлетворить несколько правил. 
          | Результат таблицы решений содержит выходные данные всех удовлетворяемых правил в порядке следования правил в таблице решений.
      * - **Output order**
        - | Результатом всех сопоставленных правил является список выходов, упорядоченных по их (убывающему) приоритету выхода.

.. _dmn_collect_operators:

Операторы для политики выбора Collect:

.. list-table::
      :widths: 10 30
      :align: center
      :class: tight-table 
      
      * - **SUM**
        - Агрегатор SUM суммирует все выходные данные выполненных правил.
      * - **MIN**
        - Агрегатор MIN можно использовать для возврата наименьшего выходного значения всех удовлетворяемых правил. 
      * - **MAX**
        - Агрегатор MAX можно использовать для возврата наибольшего выходного значения всех удовлетворяемых правил.
      * - **COUNT**
        - Агрегатор COUNT можно использовать для возврата количества выполненных правил.

Входной элемент
~~~~~~~~~~~~~~~~~~

 .. image:: _static/decision/decision_7.png
       :width: 300
       :align: center

Таблица решений может иметь один или несколько входных элементов. Входной элемент определяет идентификатор, метку, выражение и тип ввода таблицы решений.

Ввод можно редактировать, дважды кликнув заголовок соответствующего столбца в таблице решений.

.. _input_variable:

.. list-table::
      :widths: 5 10 30
      :align: center
      :class: tight-table 
      
      * - **1**
        - **Наименование входного элемента**
        - Краткое описание.  Обратите внимание, что наименование не обязательно, но рекомендуется, поскольку она помогает понять суть решения.
      * - **2**
        - **Expression**
        - | Входное выражение указывает, как генерируется значение входного предложения. 
          | Это выражение будет оцениваться механизмом DMN. Обычно это просто ссылка на переменную, которая доступна во время оценки.
      * - **3**
        - **Expression language**
        - | Язык входного выражения. Поддерживаемые языки выражений:
  
            -	JUEL
            -	FEEL

      * - **4**
        - **Input variable**
        - | Имя входной переменной. Когда входное выражение оценивается, возвращаемое значение сохраняется в переменной.
          | Переменная может использоваться в выражении входной записи. 
      * - **5**
        - **Type**
        - | Тип входного предложения. После того как входное выражение оценивается механизмом DMN, он преобразует результат в указанный тип.
          | Поддерживаемые типы:

            -	string	
            -	boolean	
            -	integer	
            -	long
            -	double
            -	date

.. note:: 

  При работе с типом string, данные необходимо писать в кавычках.

Выходной элемент
~~~~~~~~~~~~~~~~~~

 .. image:: _static/decision/decision_8.png
       :width: 700
       :align: center

Таблица решений может иметь один или несколько выходных элементов.

Выходной элемент определяет идентификатор, метку, имя и тип вывода таблицы решений.

.. list-table::
      :widths: 5 10 30
      :align: center
      :class: tight-table 
      
      * - **1**
        - **Наименование выходного элемента**
        - Краткое описание.  Обратите внимание, что наименование не обязательно, но рекомендуется, поскольку она помогает понять суть решения.
      * - **2**
        - **Output name**
        - | Имя выхода используется для ссылки на значение выхода в результате таблицы решений.
          | Если таблица решений имеет более одного выхода, то все выходы должны иметь уникальное имя.
      * - **3**
        - **Type**
        - | После того, как выходная запись оценивается механизмом DMN, он преобразует результат в указанный тип. 
          | Поддерживаемые типы:
  
            -	string	
            -	boolean	
            -	integer
            -	long
            -	double
            -	date

.. note:: 

  При работе с типом string, данные необходимо писать в кавычках.


Правило
~~~~~~~~

 .. image:: _static/decision/decision_9.png
       :width: 700
       :align: center

Таблица решений может иметь одно или несколько правил. Каждое правило содержит входные и выходные элементы. 

Входные элементы являются условием, а выходные элементы — заключением правила. Если каждый входной элемент (условие) выполняется, то правило выполняется и результат решения содержит выходные элементы (заключение) этого правила.

 .. image:: _static/decision/decision_10.png
       :width: 600
       :align: center

**1. Входной элемент**

Если входной элемент не имеет отношения к правилу, то выражение пусто.

Если в качестве языка выражений используется FEEL, то пустой входной элемент представлен как ``-`` . В противном случае выражение пусто.

Если глобальный язык выражений не установлен, вместо него используется язык выражений по умолчанию. Язык выражений по умолчанию для входных записей — `FEEL <https://docs.camunda.org/manual/7.18/reference/dmn/feel/>`_ 

**2. Выходной элемент**

Правило может иметь один или несколько выходных элементов, которые являются выводами правила.

Если выходной элемент пустой, то выходные данные игнорируются и не являются частью результата таблицы решений.

Если глобальный язык выражений не установлен, вместо него используется язык выражений по умолчанию. Язык выражений по умолчанию для выходных записей — JUEL.

**3. Описание:**

В правило может быть добавлено описание, содержащее дополнительную информацию.

Типы решения
--------------

Для решения в свойствах доступны:

 .. image:: _static/decision/decision_11.png
       :width: 300
       :align: center

По нажатию на **Empty** (1) у элемента удаляется таблица решения.

 .. image:: _static/decision/decision_12.png
       :width: 200
       :align: center

Для добавления таблицы выберите:

 .. image:: _static/decision/decision_13.png
       :width: 300
       :align: center

По нажатию на **Literal Expression** (2) доступен ввод литерального выражения.

 .. image:: _static/decision/decision_14.png
       :width: 200
       :align: center

 .. image:: _static/decision/decision_15.png
       :width: 600
       :align: center

Литеральное выражение решения представляет собой логику решения, которая может быть представлена в виде выражения в DMN 1.3. Он состоит из буквенного выражения  и переменной .

Буквенное выражение указывает, как генерируется значение решения. Это выражение будет оцениваться механизмом DMN. Его можно использовать для выполнения сложных вычислений, для вызова bean-компонента, обеспечивающего логику принятия решений, или для объединения выходных значений решений .

Литеральное выражение решения должно иметь переменную, которая определяет имя и тип результата решения. 


Пример создания таблицы принятия решений
-------------------------------------------

Кликните дважды на поле и установите название решения **«Решение по закупке»**. Далее перейдите к таблице решений, кликнув значок таблицы в верхней части решения: 

 .. image:: _static/decision/sample_1.png
       :width: 200
       :align: center

Для установки наименования входного элемента, дважды кликните поле под **«When»** и введите **«Группа товаров» (1)** в самом верхнем поле. 

Для установки  наименования выходного элемента, дважды кликните поле под **«Then»** и введите **«Согласование» (2)** в самом верхнем поле.

 .. image:: _static/decision/sample_2.png
       :width: 600
       :align: center

Предполагая, что входное значение для **«Группа товаров»** представляется переменной с именем **«type»**, входное выражение должно быть **«type»** c типом **string**.

Дважды кликните поле **«Группа товаров»**. В появившемся модальном меню установите **«type»** в качестве выражения, и тип **string**, и закройте его.

 .. image:: _static/decision/sample_3.png
       :width: 200
       :align: center

Затем дважды щелкните поле **«Согласование»** и установите **«agreement»** в качестве названия выходного элемента и тип **string**.

 .. image:: _static/decision/sample_4.png
       :width: 200
       :align: center

Далее добавьте первое правило, указывающее, что для **«Канцелярские товары» — «Разрешить»**.

Нажмите кнопку **«+»** внизу таблицы или просто нажмите в любом месте последней строки. 

В добавленной строке введите **«Канцелярские товары»** в столбце ввода и **«Разрешить»** в столбце вывода.

 .. image:: _static/decision/sample_5.png
       :width: 600
       :align: center

**«Канцелярские товары»** — условие (т. е. входной элемент) правила. Это выражение в `FEEL <https://docs.camunda.org/manual/7.18/reference/dmn/feel/>`_ , которое применяется, а затем проверяет, равно ли входное значение (т. е. переменная **«type»**) «Канцелярские товары».

**«Разрешить»** — вывод (т. е. выходной элемент) правила. Это простое выражение в JUEL возвращает строку **«Канцелярские товары»**.

Затем добавьте второй входной элемент **«Стоимость»** с входным выражением **«cost»** и типом **«integer»**. Заполните таблицу дополнительными правилами для оставшихся **Групп товаров**.

 .. image:: _static/decision/sample_6.png
       :width: 600
       :align: center

Установите для политики выбора значение **«Unique»** , которое указывает, что может совпадать только одно правило. Убедитесь, что таблица решений содержит только одно правило, которое может соответствовать входным данным.

Кликните раскрывающийся список **«Политика выбора»** и выберите политику **«Unique»**.

 .. image:: _static/decision/sample_7.png
       :width: 500
       :align: center

Реализация DMN для динамической роли
-------------------------------------

.. _dynamic_role_dmn:

Динамическая роль назначается в :ref:`типе данных<data_types_main>` на вкладке :ref:`Роли<roles_statuses>` и устанавливает гибкую логику, по которой будет произведено вычисление состава пользователей роли. 

Входными данными для вычисления DMN является заполненная **Модель** на основе рекорда. Рекорд - сущность с набором атрибутов и идентификатором записи (RecordRef), см. :ref:`подробно о Records API<Records_API>`). 

В модели могут быть использованы :ref:`системные атрибуты<system_attributes>`.

По ключу модели будут доступны вычисленные данные рекорда в контексте DMN.  

Модель заполняется в **Описании DMN**:

 .. image:: _static/decision/dmn_role_1.png
       :width: 700
       :align: center

Решение DMN должно вернуть **String** с именами реципиентов. Если в одной строке DMN необходимо перечислить несколько реципиентов, то их можно разделить запятой:

 .. image:: _static/decision/dmn_role_2.png
       :width: 600
       :align: center

- **Hit policy** указывается на ваше усмотрение, в зависимости от необходимого результата.

- Конечный **Output variable name** значения не имеет, можно оставить пустым. Главное указать тип **String**

    .. image:: _static/decision/dmn_role_3.png
       :width: 500
       :align: center

- При вычислении всегда используется последняя опубликованная версия DMN

См. :ref:`пример использования DMN для динамической роли<dynamic_role_dmn>`