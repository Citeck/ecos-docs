Базовая архитектура
====================

Система Citeck ECOS построена на основе микросервисной событийно-ориентированной архитектуры. В качестве основного способа взаимодействия микросервисов используется обмен сообщениями через очередь сообщений (MQ).

Платформа поддерживает работу с различными источниками данных без необходимости копирования данных во внутренний репозиторий. Для работы с данными используется собственный язык запросов Records API. Перечень источников данных может быть легко расширен.

Компоненты системы:

* **DAO services** – сервисы работы с контентом и метаданными. В качестве источников данных могут использоваться Alfresco Content Service, Базы данных, 1С, SAP и другие;
* **Process services** – сервисы управления бизнес-процессами, поддерживаются нотации моделирования бизнес-процессов BPMN и CMMN;
* **Application services** – сервисы управления приложениями ECOS, их версионностью и деплойментом;
* **Data services** – сервисы работы с данными, в том числе валидации данных и их индексации;
* **Integration services** – интеграционные сервисы, включая ЮЗДО;
* **API gateway** – API шлюз, используется в том числе для запросов от пользовательского интерфейса (WEB и мобильного);
* **Business logic services** – сервисы бизнес-логики и конфигурации.

Интерфейс системы разработан на базе фреймворка **ReactJS** в виде статичных **JS-библиотек**, которые раздаются через NGINX и работают под управлением веб-браузеров на пользовательских устройствах. 

Мобильный интерфейс разработан на базе фреймворка **React Native**, также поддерживается адаптивная верстка для мобильных браузеров. 

Запросы от пользовательских интерфейсов маршрутизируются через **NGINX** и **API-шлюз**.

Citeck ECOS развертывается с использование сервисов контейнеризации Docker / Kubernetes.


 .. image:: _static/base/Arch_1.png
       :width: 600
       :align: center

Микросервисы
--------------

 .. image:: _static/base/Arch_2.png
       :width: 600
       :align: center

.. list-table::
      :widths: 10 30
      :header-rows: 1
      :class: tight-table 
      
      * - Компонент
        - Описание
      * - **ecos-ui**
        - Контейнер с nginx (openresty) и UI статикой (js + css).
      * - **ecos-registry**
        - Реестр приложений и сервер Spring Cloud конфигурации.
      * - **ecos-gateway**
        - Шлюз, через который мы попадаем от клиента к серверу.
      * - **ecos-apps**
        - Микросервис приложений ECOS. Отвечает за доставку приложений ECOS к целевым сервисам.
      * - **ecos-notifications**
        - Микросервис нотификаций. Отвечает за отправку уведомлений (email, push-нотификации и др.).
      * - **ecos-model**
        - Микросервис моделей. Отвечает за информацию о типах, шаблонах нумерации и о матрицах прав.
      * - **ecos-history**
        - Микросервис истории. Подписан на события в системе и сохраняет информацию о них в БД.
      * - **ecos-process**
        - Микросервис процессов. Отвечает за процессы кейс-менеджмента и BPMN.
      * - **ecos-eis**
        - Приложение Keycloak для аутентификации в системе.
      * - **alfresco**
        - Open-source ECM система, которая может использоваться для хранения контента и метаданных документов в системе (один из вариантов реализации).
      * - **solr**
        - Система индексации метаданных и контента документов.
      * - **ecos-uiserv**
        - Микросервис UI конфигураций. Отвечает за формы, журналы, UI действия, темы, дашборды, локализацию, иконки, конфигурацию меню.
      * - **ecos-integrations**
        - Микросервис для интеграции с внешними системами (SAP, 1C, Rabbit MQ и тд.).
      * - **zookeeper**
        - Приложение для хранения конфигураций в системе. Изменения конфигурации подхватываются приложениями «на лету».
      * - **Rabbit MQ**
        - Приложение для обмена сообщениями между микросервисами.

Зависимости компонентов
------------------------

 .. image:: _static/base/Arch_3.png
       :width: 600
       :align: center

1. Центральной частью системы ECOS является абстракция **<DATA SOURCE>**, в качестве которого может выступать любой источник данных в любом из микросервисов ECOS. 
   
   Для добавления новых источников достаточно реализовать определенный интерфейс и данные из этого источника могут быть свободно интегрированы со всей экосистемой ECOS (их можно отображать в журнале, редактировать и просматривать через формы, отправлять по ним уведомления, запускать по ним процессы и т. д.).
   
   Общение с источниками данных построено на базе универсального **Records API**. Зависимости от **<DATA SOURCE>** по микросервисам:

   - **ecos-uiserv** загружает атрибуты для фильтрации UI действий по заданным в конфигурации условиям;
   - **ecos-notifications** загружает атрибуты для заполнения шаблона уведомления;
   - **ecos-history** загружает атрибуты для сохранения записи в истории;
   - **ecos-process** загружает и меняет атрибуты в ходе выполнения BPMN процессов;
   - **alfresco** загружает и меняет атрибуты в ходе выполнения CMMN процессов.

2. Почти все микросервисы работают с **Rabbit MQ** (события и команды) и с **Zookeeper** (события, конфигурация ECOS и конфигурация типов);

3. **UI** (мобильный и браузерный) зависят от **ecos-gateway** (шлюз для доступа в систему) и от **ecos-uiserv** (микросервис с UI конфигурациями);
   
4. **ecos-gateway** зависит от **ecos-model** для получения информации по пользователям и группах, в которых они состоят. Эта информация используется для формирования JWT-токена с последующей отправкой его в остальные микросервисы для аутентификации и авторизации;

5. **ecos-integrations** зависит от внешних систем, с которыми настроена интеграция;
   
6. **Alfresco** зависит от **Solr** (поиск по индексам) и от микросервиса **ecos-process** (хранение состояния процессов в системе);
   
7.  **Solr **зависит от **alfresco** для индексации данных.


Взаимодействие клиента с сервером
-----------------------------------

 .. image:: _static/base/Arch_4.png
       :width: 600
       :align: center

При первом поступлении запроса от клиента **nginx** видит, что пользователь не имеет токена и отправляет его на **Keycloak** для аутентификации через протокол OpenID Connect.

**Keycloak** может предложить окно ввода логина/пароля или сразу выдать пользователю токен, с помощью которого он сможет зайти в систему (SSO).
После успешной аутентификации пользователь перенаправляется на страницу, с которой его отправили в keycloak.

После того, как запрос прошел дальше, **ecos-gateway** смотрит на URL запроса и по нему решает, какой именно микросервис должен его обработать (например, запрос **/emodel/api/records/query** должен уйти в **ecos-model**). 

Для получения IP адреса и порта целевого микросервиса **ecos-gateway** обращается в **ecos-registry** за нужной информацией и, получив её, отправляет запрос дальше.
