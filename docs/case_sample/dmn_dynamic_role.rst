Пример использования динамической роли DMN в бизнеc-процессе
=================================================================

.. _dynamic_role_dmn:

.. contents::
		   :depth: 3

.. note::

    Данная статья является продолжением работы с созданным ранее бизнес-процессом :ref:`Заявка на закупку оборудования<sample_request>`.

    Если вы продолжаете по статье :ref:`Процесс заявки на закупку оборудования. Добавление справочника. Журнал и форма не по умолчанию<sample_request_complicated>`, то удалите **Script task «Сохранение комментария»**.

    Используйте пользователей из набора демо-данных или добавьте пользователей, как описано в статье :ref:`Создание пользователей для Citeck Community<demo_user>`

    Используйте группы из набора демо-данных или добавьте группы, как описано в :ref:`Создание группы<new_group>`

Добавим динамическую роль с :ref:`использованием таблицы DMN<ecos-dmn>` при согласовании закупки оборудования. В зависимости от условий закупки прописанных в таблице DMN, роль согласующего будет вычисляться автоматически.

Для этого необходимо:

        1.	Создать таблицу принятия решения (DMN).
        2.	Добавить в Тип данных динамическую роль DMN для согласующего.

Таблица DMN
-------------

.. note::

    Для создания модели в локальном рабочем пространстве в разделе **Администрирование** перейдите в пункт **Модели DMN** и нажмите **+ - Создать DMN модель**.

Для таблицы требуется определить критерии, по которым будет приниматься решение. 

Основные критерии - наименование оборудования и согласующий.

Для создания таблицы принятия решений  перейдите в рабочее пространство администратора. В разделе **Управление процессами** перейдите в пункт **Модели DMN**:

 .. image:: _static/dmn_dynamic_role/01.png
       :width: 700
       :align: center

Нажмите **«+ - Создать DMN модель»**:

 .. image:: _static/dmn_dynamic_role/02.png
       :width: 400
       :align: center

|

 .. image:: _static/dmn_dynamic_role/03.png
       :width: 500
       :align: center

Заполните поля:

.. list-table:: 
      :widths: 10 20 30
      :align: center
      :class: tight-table 

      * - **1**
        - Идентификатор
        - approve-equipment
      * - **2**
        - Имя
        - Согласование заявки оборудование

Нажмите **«Сохранить»**.

Для перехода к редактору разверните раздел **«По умолчанию»**, наведите курсор на созданную модель и нажмите:

 .. image:: _static/dmn_dynamic_role/04.png
       :width: 600
       :align: center

Откроется решение:

 .. image:: _static/dmn_dynamic_role/05.png
       :width: 600
       :align: center

В правой части в модели необходимо определить входные данные для вычисления роли на основе DMN.

По **ключу модели** будут доступны вычисленные данные в контексте DMN.  

 .. image:: _static/dmn_dynamic_role/06.png
       :width: 300
       :align: center

Зададим сопоставление ключ и значение:

.. list-table:: 
      :widths: 5 5 10
      :align: center
      :class: tight-table 

      * - **Ключ**
        - name
        - входной элемент для решения, который далее необходимо указать в **expression**. 
      * - **Значение**
        - name
        - атрибут типа данных. То самое условие, по которому будет вычисляться роль.

.. note:: 

    Ключ-значений (условий) может быть несколько, а для каждого условия будет вычисляться необходимая роль.

Для ввода данных в таблицу кликните:

 .. image:: _static/dmn_dynamic_role/07.png
       :width: 200
       :align: center

|

 .. image:: _static/dmn_dynamic_role/08.png
       :width: 500
       :align: center

Двойным кликом по наименованию решения **(1)** перейдите в режим редактирования и назовите решение **Decision_furniture**.

**Hit policy (2)** -  :ref:`политика выбора<dmn_hit_policy>` Определим ее как **Unique** (по умолчанию).

**(3)** – входные элементы, **(4)** – выходные элементы.

Совокупность входных элементов и выходного формируют решение.

Входные элементы 
~~~~~~~~~~~~~~~~~

Для установки наименования входного элемента, дважды кликните поле под **When** и введите **«Наименование»**:

 .. image:: _static/dmn_dynamic_role/09.png
       :width: 500
       :align: center

В свойствах укажите:

.. list-table:: 
      :widths: 10 20 30
      :header-rows: 1
      :align: center
      :class: tight-table 

      * - Поле
        - Значение
        - Пояснение
      * - Expression
        - name
        - Ключ из модели
      * - Type
        - string
        - Соответствует типу атрибута name из типа данных

Выходной элемент
~~~~~~~~~~~~~~~~~

Наименование выходного элемента, дважды кликните поле под **Then** и введите **«Согласующий»**:

 .. image:: _static/dmn_dynamic_role/10.png
       :width: 500
       :align: center

В свойствах укажите:

.. list-table:: 
      :widths: 10 20 30
      :header-rows: 1
      :align: center
      :class: tight-table 

      * - Поле
        - Значение
        - Пояснение
      * - Type
        - string
        - Чтобы решение DMN вернуло String с именами реципиентов.

Правила
~~~~~~~~~

.. _rules_groupnames_dmn:

Выберем 3 наименования оборудования. Укажем для каждого наименования соответствующего согласующего.

.. note:: 

  Системное имя пользователя можно получить в Оргструктуре, открыв профиль пользователя:

    .. image:: _static/dmn_dynamic_role/org_1.png
       :width: 700
       :align: center

  Группы:

    .. image:: _static/dmn_dynamic_role/org_2.png
       :width: 400
       :align: center  

    |

    .. image:: _static/dmn_dynamic_role/org_3.png
       :width: 500
       :align: center

Добавьте первое правило, указывающее, что для наименования **«Ноутбук»** — согласующий с системным именем **«alexandra.filchenko»** и группа **«GROUP_company_chief_accountant»**.

.. note:: 

    Если указывать группу, то перед именем группы необходимо добавить ``GROUP_``

    **Наименование** и **Согласующий** типа **string**, поэтому элементы обязательно указывать в **кавычках**.

    Несколько значений добавляется через запятую без пробелов в одних кавычках.

.. image:: _static/dmn_dynamic_role/11.png
    :width: 600
    :align: center

Нажмите кнопку **+** внизу таблицы или просто нажмите в любом месте последней строки.

Добавьте второе правило, указывающее, что для наименования **«Компьютер»** — согласующий с логином **«elvira.danilenko»**.

 .. image:: _static/dmn_dynamic_role/12.png
       :width: 600
       :align: center

Финальная таблица:

.. list-table:: 
      :widths: 20 30
      :header-rows: 1
      :align: center
      :class: tight-table 

      * - Наименование
        - Согласующий

      * - |

          .. code-block::

            "Ноутбук"

        - |

          .. code-block::

            "alexandra.filchenko,GROUP_company_accountant"

      * - |

          .. code-block::

            "Компьютер"

        - |

          .. code-block::

            "elvira.danilenko"

      * - |

          .. code-block::

            "Сервер"

        - |

          .. code-block::

            "GROUP_production_director"

Решение DMN должно вернуть **String** с именами реципиентов.

Теперь таблицу принятия решения можно сохранить и опубликовать, нажав:

 .. image:: _static/dmn_dynamic_role/13.png
       :width: 600
       :align: center


Тип данных
-----------

Во вкладке «Роли» созданного ранее типа данных необходимо назначить согласующему динамическую роль:

 .. image:: _static/dmn_dynamic_role/16.png
       :width: 600
       :align: center

В форме выберите тип **DMN**, решение – **Decision_equipment**:

 .. image:: _static/dmn_dynamic_role/17.png
       :width: 500
       :align: center

Нажмите **Подтвердить**.


Проверка процесса
---------------------

Перейдите в журнал, создайте новую заявку, заполните карточку, нажмите **«Сохранить»**:

 .. image:: _static/dmn_dynamic_role/28.png
       :width: 500
       :align: center

На статусе **«На согласовании»** исполнители  - Александра Фильченко (аккаунт **alexandra.filchenko**) и Главный бухгалтер (группа **company_accountant**):

 .. image:: _static/dmn_dynamic_role/29.png
       :width: 700
       :align: center

Проверка прав через консоль браузера
---------------------------------------

Назначенную роль можно проверить через консоль браузера командой:

``await Records.get('emodel/type-id@local-id').load('_roles.assigneesOf.approver[]?str', true)``

где 

  ``approver`` - id роли из типа данных

  ``emodel/type-id@local-id`` – можно взять из строки браузера:

.. image:: _static/dmn_dynamic_role/31.png
       :width: 700
       :align: center

Система выдаст кому назначена данная задача согласования:

.. image:: _static/dmn_dynamic_role/30.png
       :width: 600
       :align: center

