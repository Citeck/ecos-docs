Процесс запроса на закупку оборудования
=======================================

Данная статья знакомит пользователей с основами ECOS на примере создания бизнес-процесса «Заявка на закупку оборудования».

**Заявка на оборудование** – заявка, которая необходима для закупки оборудования для операционной деятельности сотрудников. Например, для подключения монитора к компьютеру сотруднику необходим специальный кабель, которого на данный момент нет в наличии. 

Обычно сотрудник обращается к своему руководителю с просьбой, чтобы для него (сотрудника) необходимое оборудование было приобретено, после успешного согласования с руководителем и в соответствии с внутренними правилами и распорядками происходит закупка. Согласующий так же может отказать в покупке. 

Далее мы пошагово реализуем описанный сценарий с использованием инструментов ECOS.

Для закупки оборудования нам потребуется следующая информация: 

    -	**Инициатор** – сотрудник, которому необходимо оборудование; 
    -	**Согласующий** – сотрудник, ответственный за согласование приобретаемого оборудования;
    -	**Название** – наименование приобретаемого оборудования; 
    -	**Стоимость** – стоимость оборудования.

До создания самого бизнес-процесса необходимо создать ряд :ref:`артефактов<ecos_artifacts>` в следующем порядке:

    - :ref:`тип данных<data_types_main>`;
    - :ref:`журнал<journals>`;
    - :ref:`форма <forms>` ;
    - :ref:`процесс<ecos_bpmn>`.

Тип данных
----------

**Тип данных** - основной источник метаданных работы с объектом.

Для создания типа данных перейдите в журнал **«Типы данных» (Раздел администратора - Модель - Журналы)**:

  .. image:: _static/equipment_request/type_new_1.png
       :width: 600
       :align: center

нажмите **+ - Создать новый тип**:

  .. image:: _static/equipment_request/type_new_2.png
       :width: 600
       :align: center

Основное
~~~~~~~~

На вкладке расположены основные данные по типу данных (объекту):

.. list-table:: 
      :widths: 10 20 30
      :align: center
      :class: tight-table 

      * - **1**
        - id
        - equipment-request
      * - **2**
        - Имя
        - Заявка на покупку оборудования
      * - **3**
        - Родитель
        - Кейс
      * - **4**
        - Форма
        - Оставить по умолчанию (система автоматически сгенерирует форму по тем атрибутам, которые мы укажем далее, но автоматически сгенерированные формы нельзя редактировать)
      * - **5**
        - Журнал
        - Оставить по умолчанию (система автоматически сгенерирует журнал по тем атрибутам, которые мы укажем далее, но автоматически сгенерированные журналы нельзя редактировать)

Конечная настройка вкладки:

  .. image:: _static/equipment_request/tab_1.png
       :width: 600
       :align: center

Атрибуты
~~~~~~~~

На вкладке находится информация о свойствах, которые будут использованы для взаимодействия с объектом.

Для создания заявки нам потребуется следующая информация: 
    -	что нужно купить, 
    -	сколько стоит, 
    -	кто запрашивает 
    -	кто согласует закупку.

И, соответственно, нам потребуются следующие атрибуты (свойства объекта):

.. list-table:: 
      :widths: 10 20 30
      :header-rows: 1
      :align: center
      :class: tight-table 

      * - Id (1)
        - Имя (2)
        - Тип (3)
      * - name
        - Название оборудования
        - Text
      * - price
        - Стоимость
        - Number
      * - requester
        - Инициатор
        - Person
      * - approver
        - Согласующий
        - Person

Конечная настройка вкладки:

  .. image:: _static/equipment_request/tab_2.png
       :width: 600
       :align: center

Роли
~~~~

На вкладке описываются роли, которые участвуют в работе с объектом, в нашем случае, участвуют в работе с заявкой.  

Смотря на атрибуты, несложно догадаться, что нам потребуется на первом этапе две роли: **Инициатор** и **Согласующий**. 

.. list-table:: 
      :widths: 10 20 30
      :header-rows: 1
      :align: center
      :class: tight-table 

      * - Id (1)
        - Имя (2)
        - | Атрибут (3) 
          | (Выбирается из указанных ранее атрибутов. 
          | По клику на поле, выпадает список указанных атрибутов на вкладке "Атрибуты")
      * - requestor
        - Инициатор
        - Инициатор
      * - approver
        - Согласующий
        - Согласующий


Конечная настройка вкладки:

  .. image:: _static/equipment_request/tab_3.png
       :width: 600
       :align: center


Статусы
~~~~~~~

На вкладке описываются статусы, по которым будет перемещаться объект (наша заявка) по бизнес-процессу. 

Рассмотрим самый простой и успешный вариант процесса. 

Инициатор создаёт заявку (статус **«Заявка создана»**), далее отправляет её на согласование согласующему (статус **«На согласовании»**), после Согласующий одобряет заявку (статус **«Одобрено»/«Согласовано»**). 

.. list-table:: 
      :widths: 10 20
      :header-rows: 1
      :align: center
      :class: tight-table 

      * - Id (1)
        - Имя (2)
      * - request-created
        - Заявка создана
      * - approving
        - На согласовании
      * - approved
        - Согласовано
      * - rejected
        - Отказано

Конечная настройка вкладки:

  .. image:: _static/equipment_request/tab_4.png
       :width: 600
       :align: center

Для сохранения нажмите **«Создать» (Сохранить)**. 

На этом создание базового варианта типа данных для заявки закончено. 

Промежуточный итог
~~~~~~~~~~~~~~~~~~~~~

-	указали базовую информацию о типе данных: id, название типа данных, 
- форму и журнал система сгенерировала автоматически на основании введенных данных;
-	описали свойства заявки, с которыми дальше будем взаимодействовать;
-	добавили роли, которые будут участвовать в работе с заявкой;
-	обозначили статусы, по которым будет перемещаться заявка.

Форма
------

Посмотрим, как выглядит сгенерированная автоматически форма. Помните, что автоматически сгенерированные формы нельзя редактировать.

Для этого на открывшейся вкладке **«Тип «Заявка на покупку оборудования»** нажмите **«Форма по умолчанию»**. 

  .. image:: _static/equipment_request/auto_form_1.png
       :width: 600
       :align: center

В открывшейся вкладке в виджете **«Действия»** нажмите  **«Редактировать форму»**:

  .. image:: _static/equipment_request/auto_form_2.png
       :width: 600
       :align: center

Данная форма была автоматически сгенерирована системой из атрибутов, которые были указаны в типе данных: 

  .. image:: _static/equipment_request/auto_form_3.png
       :width: 600
       :align: center

Тип компонента на форме зависит от типа атрибута, указанного в типе данных. 

Например, компонент **Стоимость** имеет тип **Number**, так как в типе атрибута был указано значение Number. 

Это можно проверить, наведя курсор на компонент с названием **«Стоимость»**, и далее, нажав на шестерёнку в правом-верхнем углу компонента^

  .. image:: _static/equipment_request/auto_form_4.png
       :width: 600
       :align: center

В заголовке модального окна видно, что компонент имеет тип **Number**. 

А в поле **Имя свойства** указано значение **«price»**, это значение было указано ранее в типе данных.

  .. image:: _static/equipment_request/auto_form_5.png
       :width: 600
       :align: center

Журнал
-------

Для просмотра журнала необходимо его добавить в левое меню:

1.	Перейдите в настройку меню, нажав на шестеренку справа сверху, далее выберите **«Настроить меню»**:

  .. image:: _static/equipment_request/menu_1.png
       :width: 600
       :align: center

2.	Перейдите во вкладку **«Настройки выбранной конфигурации»**, нажмите **«+ Добавить»**, выберите **«Раздел»**:

  .. image:: _static/equipment_request/menu_2.png
       :width: 600
       :align: center

3.	В поле **«Название»** введите название раздела. Например, «Оборудование». Нажмите **«Сохранить»**.

  .. image:: _static/equipment_request/menu_3.png
       :width: 400
       :align: center

4.	Наведите курсор на добавленный раздел, нажмите **«+ Добавить»**, выберите **«Журнал»**:

  .. image:: _static/equipment_request/menu_4.png
       :width: 600
       :align: center

Выберите журнал **«type$equipment-request»** и нажмите **ОК**:

  .. image:: _static/equipment_request/menu_5.png
       :width: 600
       :align: center

  .. image:: _static/equipment_request/menu_6.png
       :width: 600
       :align: center

5.	Нажмите **«Применить»**.

В левом меню появился новый журнал **«Заявка на покупку оборудования»**:

  .. image:: _static/equipment_request/menu_7.png
       :width: 200
       :align: center

Нажав на этот пункт меню, откроется новая ECOS вкладка с автоматически сгенерированным журналом. 
В журнале присутствуют колонки, которые относятся непосредственно к атрибутам, которые были указаны ранее в типе данных:

  .. image:: _static/equipment_request/journal_1.png
       :width: 600
       :align: center

Создать заявку в журнале пока невозможно, так как для объекта еще не задано описание процесса, по которому будет проходить его жизненный цикл.

Бизнес-процесс
----------------

Перейдите в левом меню в пункт **«Редактор бизнес-процессов»**:

  .. image:: _static/equipment_request/bp_new.png
       :width: 600
       :align: center

Для создания процесса нажмите **«+ - Создать camunda процесс»**:

  .. image:: _static/equipment_request/bp_new_1.png
       :width: 600
       :align: center

В открывшемся модальном окне заполните поля:

.. list-table:: 
      :widths: 10 20 30
      :align: center
      :class: tight-table 

      * - **1**
        - Идентификатор
        - equipment-request
      * - **2**
        - Имя
        - Заявка на покупку оборудования
      * - **3**
        - Data type
        - equipment-request
      * - **4**
        - Включен
        - True. Отметка об активности процесса.
      * - **5**
        - Автоматический старт процесса. 
        - True, чтобы старт процесса осуществлялся автоматически. Подробно о :ref:`запуске процесса<new_bp_start>`

Конечная настройка бизнес-процесса:

  .. image:: _static/equipment_request/bp_new_2.png
       :width: 600
       :align: center

Нажмите **«Сохранить»**.

Далее необходимо описать схему процесса в :ref:`редакторе бизнес-процессов<editor_bpmn>`.

Для перехода к редактору разверните раздел **«По умолчанию»**, наведите курсор на созданный процесс и нажмите:

  .. image:: _static/equipment_request/bp_new_3.png
       :width: 600
       :align: center

Откроется **конструктор бизнес-процесса**:

  .. image:: _static/equipment_request/modeller.png
       :width: 600
       :align: center

Процесс прохождения заявки опишем следующим образом:

**Создать заявку -> Отправить на согласование -> Согласовать/Отклонить заявку**

1.	Автоматически на схему добавляется компонент, который отвечает за начало процесса (:ref:`Start event <bpmn_events>`). 

**Start event компонент** слушает систему и ждёт, когда в систему постучится запрос на создание нового объекта с нужным нам типом данных.

Выделите **Start Event компонент** - рядом с компонентом расположено контекстное меню, с помощью которого в процесс можно добавлять новые элементы, связи между элементами, или редактировать текущий элемент. 

  .. image:: _static/equipment_request/start_event.png
       :width: 200
       :align: center

2.	Теперь нужно добавить новый элемент, но какой? 

Сразу после создания заявки, она должна получить статус **«Заявка создана»** - нажмите на элемент :ref:`Set status<set_status>` в контекстном меню: 

  .. image:: _static/equipment_request/set_status.png
       :width: 200
       :align: center

Справа от области для схемы появляются настройки добавленного компонента, где необходимо указать **имя (1)** и **cтатус (2)**, который будет присвоен объекту на данном этапе.

Укажите имя **«Статус «Заявка создана»**. В поле «Статус» выберите вариант **«Заявка создана»**.

  .. image:: _static/equipment_request/set_status_prop.png
       :width: 300
       :align: center

3.	Когда заявка создана, нужно проверить всё содержимое заявки, а после проверки отправить на согласование. 

Для этого необходимо создать задачу для пользователя - в контекстном меню нажмите на компонент **«Task»**:

  .. image:: _static/equipment_request/User_task_1.png
       :width: 300
       :align: center

Но данный компонент не подходит, и необходимо изменить его тип с «Task» на :ref:`User task<user_task>`. Для этого нажмите на гаечный ключ и выберите вариант **«User task»**:

  .. image:: _static/equipment_request/User_task_2.png
       :width: 400
       :align: center

Далее нужно правильно настроить задачу для пользователя, укажите в форме:

  -	Имя - **«На согласование»**, 
  -	Реципиент - **«Инициатор»**
  
  .. image:: _static/equipment_request/User_task_prop.png
       :width: 300
       :align: center

К задаче необходимо создать форму. Формы для задач обычно состоят из комментариев и кнопок, которые обозначают результат выполнения задачи.

В данном случае не нужен комментарий, на текущем этапе достаточно одной кнопки, которая будет отвечать за исход задачи «На согласование». 

Для этого следует выполнить следующие действия:

  -	На панели настроек компонента User Task нажмите под полем «Форма задачи» кнопку **«Выбрать»**:

  .. image:: _static/equipment_request/form_common_1.png
       :width: 300
       :align: center

 -	В верхней части нажмите на выпадающий список **«Создать»**, выберите вариант **«Создать форму»**:

   .. image:: _static/equipment_request/form_common_2.png
       :width: 600
       :align: center

  -	Заполните поля следующими данными:

    -	Идентификатор формы - **«equipment-request-send-to-approve-form»**
    -	Название формы – **«Отправить на согласование форма»**

  -	Нажмите кнопку **«Редактировать форму»**:

   .. image:: _static/equipment_request/form_to_approve_1.png
       :width: 600
       :align: center

  -	Удалите текстовый компонент с именем **«Название»**

  -	Удалите компонент кнопка с названием **«Отменить»**

   .. image:: _static/equipment_request/form_common_3.png
       :width: 600
       :align: center

 -	На кнопке **«Создать»** нажмите на кнопку редактирования (шестерёнка):

   .. image:: _static/equipment_request/form_common_4.png
       :width: 600
       :align: center

  -	В поле **«Имя свойства»** введите значение **«outcome_ToApprove»**

    -	В данном случае приставка «outcome» используется как обозначение, что кнопка отвечает за один из вариантов исхода выполнения задачи
    -	ToApprove выступает в роли Идентификатора исхода задачи

  -	В поле **«Название»** поля введите значение **«На согласование»**

  -	Нажмите кнопку **«Сохранить»**

   .. image:: _static/equipment_request/form_to_approve_2.png
       :width: 600
       :align: center

 -	Нажмите кнопку **«Сохранить»**

   .. image:: _static/equipment_request/form_to_approve_3.png
       :width: 600
       :align: center

 -	Нажмите кнопку **«Сохранить»**

    .. image:: _static/equipment_request/form_to_approve_4.png
       :width: 600
       :align: center

-	Вернувшись к компоненту **User Task**, заполните список **«Результаты задачи»** следующими значениями

  -	Идентификатор – **ToApprove**
  -	Название – **На согласование**

    .. image:: _static/equipment_request/form_to_approve_5.png
       :width: 400
       :align: center

4.	Задача создана и после отправки на согласование необходимо изменить статус задачи на **«На согласовании»**. Для этого повторяем действия первой смены статуса (пункт 2):

  -	Нажмите в контекстном меню на иконку **Set Status**

  .. image:: _static/equipment_request/set_status_2.png
       :width: 400
       :align: center  

  -	Укажите в поле «Имя» **«Статус «На согласовании»**. 
  -	В поле «Статус» выберите вариант **«На согласовании»**.

  .. image:: _static/equipment_request/set_status_2_prop.png
       :width: 400
       :align: center

5.	Далее необходимо создать аналогичную задачу только уже для согласующего:

  -	Добавьте при помощи контекстного меню компонент **Task**

  .. image:: _static/equipment_request/User_task_3.png
       :width: 400
       :align: center

  -	Измените тип компонента с **Task** на **User Task**:

  .. image:: _static/equipment_request/User_task_4.png
       :width: 500
       :align: center

  -	Поле **«Имя»** - **«На согласовании согласующим»**, 
  -	Поле **«Реципиент»** - **«Согласующий»**. 

  .. image:: _static/equipment_request/User_task_2_prop.png
       :width: 300
       :align: center

К задаче необходимо создать форму. Формы для задач обычно состоят из комментариев и кнопок, которые обозначают результат выполнения задачи.

В данном случае не нужен комментарий, на текущем этапе достаточно одной кнопки, которая будет отвечать за исход задачи «На согласование». 

Для этого следует выполнить следующие действия:

  -	На панели настроек компонента User Task под полем **«Форма задачи»** нажмите кнопку **«Выбрать»**:

  .. image:: _static/equipment_request/form_common_1.png
       :width: 300
       :align: center

 -	В верхней части нажмите **«Создать»**, выберите вариант **«Создать форму»**:

   .. image:: _static/equipment_request/form_common_2.png
       :width: 600
       :align: center

  -	Заполните поля следующими данными:

    -	Идентификатор формы - **«equipment-request-approve-form»**
    -	Название формы – **«Форма согласования заявки на покупку оборудования»**

  -	Нажмите кнопку **«Редактировать форму»**:

   .. image:: _static/equipment_request/request_approve_1.png
       :width: 600
       :align: center

  -	Удалите текстовый компонент с именем **«Название»**

   .. image:: _static/equipment_request/form_common_3_1.png
       :width: 600
       :align: center

 -	На кнопке **«Создать»** нажмите на кнопку редактирования (шестерёнка):

   .. image:: _static/equipment_request/form_common_4.png
       :width: 600
       :align: center

  -	В поле **«Имя свойства»** введите значение **«outcome_Approve**

    -	В данном случае приставка «outcome» используется как обозначение, что кнопка отвечает за один из вариантов исхода выполнения задачи
    -	Approve выступает в роли Идентификатора исхода задачи

  -	В поле **«Название»** поля введите значение **«Согласовать»**

  -	Нажмите кнопку **«Сохранить»**

   .. image:: _static/equipment_request/request_approve_2.png
       :width: 600
       :align: center

 -	На кнопке **«Отменить»** нажмите на кнопку редактирования (шестерёнка)

    .. image:: _static/equipment_request/request_approve_6.png
       :width: 600
       :align: center

    -	В поле **«Имя свойства»** введите значение **«outcome_Reject»**
    -	В поле **«Название поля»** введите значение **«Отказать»**
    -	В поле Действие выставите значение **«Submit»**

    .. image:: _static/equipment_request/request_approve_7.png
       :width: 600
       :align: center

 -	Нажмите кнопку **«Сохранить»**

   .. image:: _static/equipment_request/request_approve_3.png
       :width: 600
       :align: center

 -	Нажмите кнопку **«Сохранить»**

    .. image:: _static/equipment_request/request_approve_4.png
       :width: 600
       :align: center

-	Вернувшись к компоненту **User Task**, заполните список **«Результаты задачи»** следующими значениями

  -	Идентификатор – **Approve**, Название – **Согласовать**
  - Идентификатор – **Reject**, Название – **Отказать**

    .. image:: _static/equipment_request/request_approve_5.png
       :width: 400
       :align: center

6. После согласования Согласующим задача должна завершиться, но исходов у процесса два – покупка согласована, или в покупке отказано, потому поставим следующий компонентом разветвитель - :ref:`Gateway <gateways>`

**Gateway компонент** отвечает за разветвление маршрутов и за слияние потоков. Для его добавления необходимо нажать на соответствующую иконку в контекстном меню или на панели слева (но в этом случае придётся самостоятельно проставлять связи их направления):

    .. image:: _static/equipment_request/gateway_1.png
       :width: 500
       :align: center

|

    .. image:: _static/equipment_request/gateway_2.png
       :width: 500
       :align: center

7. После Gateway необходимо поставить 2 компонента смены статуса на «Согласовано»/ «Отказано». Для этого повторяем действия первой смены статуса (пункт 2):

  -	Нажмите в контекстном меню на иконку **Set Status**

  .. image:: _static/equipment_request/set_status_3.png
       :width: 500
       :align: center  

  -	Укажите в поле «Имя» **«Статус «Согласовано»**. 
  -	В поле «Статус» выберите вариант **«Согласовано»**.

  .. image:: _static/equipment_request/set_status_3_prop.png
       :width: 300
       :align: center

  -	Нажмите в контекстном меню на иконку **Set Status**
  - Укажите в поле «Имя» **«Статус «Отказано»**. 
  -	В поле «Статус» выберите вариант **«Отказано»**.

  .. image:: _static/equipment_request/set_status_4_prop.png
       :width: 300
       :align: center

8.	Так как из Gateway, потенциально, может быть несколько потоков, то система умеет определять по какому потоку нужно идти при помощи вариантов исхода (исходы настраиваются при помощи кнопок на форме и стрелок, выходящих из компонента Gateway). 

Для настройки выберите «стрелку» (отдельный компонент **Sequence Flow**, который отвечает не только за визуализацию направления). 

Для потока **«Согласовано»**:

  .. image:: _static/equipment_request/Sequence_Flow_1.png
       :width: 500
       :align: center

  -	В поле «Имя» укажите **«Согласовано»**. 
  -	В поле «Тип условия» выберите вариант **«Исходящий»**.
  -	В появившемся поле Исходящий выбрать вариант **«На согласовании согласующим - Согласовать»**. Варианты автоматически генерируются из двух частей: первая – название задачи (поле Имя), вторая – название результатов задач.

  .. image:: _static/equipment_request/Sequence_Flow_2.png
       :width: 300
       :align: center

Для потока **«Отказано»**:

  .. image:: _static/equipment_request/Sequence_Flow_3.png
       :width: 500
       :align: center

  -	Укажите имя **«Отказано»**. 
  -	В поле **«Тип условия»** выберите вариант **«Исходящий»**.
  -	В появившемся поле Исходящий выбрать вариант **«На согласовании согласующим - Отказать»**. 

  .. image:: _static/equipment_request/Sequence_Flow_3.png
       :width: 500
       :align: center


9.	Дальше необходимо добавить компонент, который будет означать, что процесс закончен. Для этого в контекстном меню компонентов **«Статус «Согласовано»** и **«Статус «Отказано»** нужно нажать на иконку :ref:`End event<bpmn_events>` компонента.

  .. image:: _static/equipment_request/end_event_1.png
       :width: 500
       :align: center

Так же для второго выхода gateway добавим **End Event компонент**. 

Теперь процесс можно сохранить и опубликовать, нажав:

  .. image:: _static/equipment_request/publish.png
       :width: 600
       :align: center

Запуск процесса
-----------------

После того, как создан Тип данных, бизнес-процесс, Журнал и Форма, можно проверить, как процесс работает.

Создайте 2 пользователей с именами **requestor** и **approver**, как написано в :ref:`инструкции<demo_user>`. Список созданных пользователей:

  .. image:: _static/equipment_request/users.png
       :width: 600
       :align: center

Зайдите под **requestor**:

В левом меню выберите **«Запрос на оборудование»**. Откроется журнал, где нет записей. Для создания нового объекта (заявки на покупку оборудования). нажмите на **«+»**:

  .. image:: _static/equipment_request/new_request_1.png
       :width: 600
       :align: center

Заполните поля соответствующими данными. Например:

-	Название оборудование – **HDMI кабель**
-	Стоимость - **500**
-	Инициатор – **Инициатор(requestor)**
-	Согласующий – **Согласующий(approver)**

И нажмите **«Сохранить»**.

  .. image:: _static/equipment_request/new_request_2.png
       :width: 400
       :align: center

Создана первая заявка в статусе **«Заявка создана»** и далее проведем ее по нашему бизнес-процессу. 

В виджете **«Мои задачи»** нажмите кнопку **«Отправить на согласование».** 

  .. image:: _static/equipment_request/new_request_3.png
       :width: 600
       :align: center

После выполнения задачи заявка перейдёт в статус **«На согласовании»** и на Согласующего (approver) будет назначена задача - **Согласование**. 

Зайдите под **approver**:

В левом меню перейдите в **Активные задачи**, откройте задачу, нажав:

  .. image:: _static/equipment_request/new_request_4.png
       :width: 800
       :align: center

Для согласования в виджете **«Мои задачи»** нажмите кнопку **«Согласовать»**:

  .. image:: _static/equipment_request/new_request_5.png
       :width: 600
       :align: center

После выполнения задачи заявка перейдёт в статус **«Согласовано»**.

Поздравляю, первая заявка прошла полный процесс, который был только что создан Вами.
